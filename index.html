
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Batch Scanner → MS Form</title>
  <style>
    :root {
      --bg: #0b1220;
      --card: #0f172a;
      --border: #1f2a44;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --primary: #0ea5e9;
      --secondary: #475569;
      --good: #10b981;
      --warn: #f59e0b;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    .wrap { max-width: 720px; margin: 0 auto; padding: 16px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; }
    h1 { margin:0 0 6px; font-size:22px; }
    .hint { color:var(--muted); font-size:12px; margin-bottom:12px; }
    /* Camera box now nearly full screen height on phones */
    .camBox { width:100%; height:1.5cm; max-height:2cm; margin:6px auto 10px; background:#000; border-radius:16px; overflow:hidden; display:flex; align-items:center; justify-content:center; border:1px solid #2a334d; }
    video { width:100%; height:100%; object-fit:cover; transform:none; }
    .btn { width:100%; padding:14px 16px; border-radius:12px; border:none; font-weight:800; font-size:16px; letter-spacing:.4px; }
    .primary { background:var(--primary); color:white; }
    .secondary { background:var(--secondary); color:#e5e7eb; }
    .good { background:var(--good); color:white; }
    .warn { background:var(--warn); color:black; }
    .rowgap { height:10px; }
    .label { font-size:12px; color:var(--muted); margin: 8px 4px 4px; }
    .result { text-align:center; font-weight:900; font-size:36px; letter-spacing:1px; margin:8px 0; word-break:break-all; min-height:44px; }
    .box { width:100%; padding:12px; border-radius:12px; border:1px solid var(--border); background:#0b1326; color:var(--text); }
    .box.mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:16px; }
    .stack { display:flex; gap:10px; }
    .stack .btn { flex:1 1 0; }
    .status { text-align:center; font-size:12px; color:var(--muted); min-height:16px; }
    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#111827; color:#e5e7eb; border:1px solid #374151; padding:8px 12px; border-radius:10px; }
    .small { font-size:12px; color:var(--muted); }
    .flash { margin-top:6px; text-align:center; }
    .flash button { background:#1f2937; color:#e5e7eb; border:none; padding:6px 10px; border-radius:10px; font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Scan Batch → Record</h1>
      <div class="hint">Flow: <b>Start Camera</b> (flash auto on) → <b>SCAN</b> → verify / correct <b>Date & Time</b> → tap <b>START USE</b> or <b>FINISH USED</b> → copy instruction → <b>Go to record on MS‑Form</b>.</div>

      <div class="camBox">
        <video id="video" playsinline></video>
      </div>
      <div class="flash"><button id="btnFlash">Flash: off</button></div>

      <div class="rowgap"></div>
      <button id="btnStart" class="btn primary">Start Camera</button>

      <div class="rowgap"></div>
      <button id="btnScan" class="btn secondary">SCAN</button>

      <div id="scanValue" class="result">—</div>

      <div class="label">Date & time of scan (editable)</div>
      <input id="dtInput" class="box mono" />

      <div class="rowgap"></div>
      <div class="stack">
        <button id="btnStartUse" class="btn good">START USE</button>
        <button id="btnFinishUsed" class="btn warn">FINISH USED</button>
      </div>

      <div class="label">Instruction message (copy to paper)</div>
      <textarea id="instruction" class="box mono" rows="3" readonly></textarea>

      <div class="rowgap"></div>
      <button id="btnForm" class="btn secondary">Go to record on MS‑Form</button>

      <div class="status" id="status">Point at barcode, press SCAN. You can rescan any time.</div>
      <div class="small" style="margin-top:8px;">Tip: After opening the form, long‑press the first field and Paste.</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/index.min.js"></script>
  <script>
    const FORMS_URL = "https://forms.office.com/Pages/ResponsePage.aspx?id=EhsYHpKcZU2onbGGEHzETbeUVW5sz-BJrp_dYv8vQNtUNDVIWkJJTFBYUzVXTDRQVU1VQ0tTQ1JBMS4u";
    const BATCH_PARAM = "BatchID";

    let stream = null;
    let lastCode = "";
    let torchOn = false;
    let usedAction = ""; // "START USE" or "FINISH USED"

    const els = {
      video: document.getElementById('video'),
      btnStart: document.getElementById('btnStart'),
      btnScan: document.getElementById('btnScan'),
      btnStartUse: document.getElementById('btnStartUse'),
      btnFinishUsed: document.getElementById('btnFinishUsed'),
      btnForm: document.getElementById('btnForm'),
      btnFlash: document.getElementById('btnFlash'),
      scanValue: document.getElementById('scanValue'),
      dtInput: document.getElementById('dtInput'),
      instruction: document.getElementById('instruction'),
      status: document.getElementById('status')
    };

    function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),1800); }

    function pad(n){ return String(n).padStart(2,'0'); }
    function localNowStr(){
      const d=new Date();
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    function setNow(){ els.dtInput.value = localNowStr(); }
    setNow();

    function setScan(val, fmt){
      lastCode = val || "";
      els.scanValue.textContent = lastCode || "—";
      updateInstruction();
      els.status.textContent = fmt ? ("Format: "+fmt) : "";
    }

    function updateInstruction(){
      if(!lastCode){ els.instruction.value = ""; return; }
      const dt = els.dtInput.value || localNowStr();
      const act = usedAction || "(select START/FINISH)";
      els.instruction.value = `BATCH: ${lastCode} | TIME: ${dt} | ACTION: ${act}`;
      try{ localStorage.setItem('lastInstruction', els.instruction.value); }catch{}
    }

    async function startCamera(){
      try{
        stopCamera();
        const constraints = {
          video: {
            facingMode: { ideal: "environment" },
            width: { ideal: 1920 },
            height: { ideal: 1080 },
            advanced: [{ torch: true }]
          },
          audio: false
        };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        els.video.srcObject = stream;
        await els.video.play();
        // ensure not mirrored
        els.video.style.transform = "none";
        await setTorch(true);
        els.status.textContent = "Camera ready. Tap SCAN to capture.";
      }catch(e){
        console.warn(e);
        els.status.textContent = "Camera error. Ensure HTTPS + permissions.";
      }
    }

    function stopCamera(){
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; torchOn=false; updateFlashLabel(); }
    }

    async function setTorch(on){
      const track = stream ? stream.getVideoTracks()[0] : null;
      if(!track) return false;
      const caps = track.getCapabilities ? track.getCapabilities() : {};
      if(!caps.torch){ updateFlashLabel(false); return false; }
      try{
        await track.applyConstraints({ advanced: [{ torch: on }] });
        torchOn = on; updateFlashLabel(true);
        return true;
      }catch(e){
        console.warn("Torch apply failed", e);
        updateFlashLabel(false);
        return false;
      }
    }
    function updateFlashLabel(supported){
      if(!supported && torchOn===false){ els.btnFlash.textContent = "Flash: n/a"; return; }
      els.btnFlash.textContent = "Flash: " + (torchOn ? "on" : "off");
    }

    async function scanOnce(){
      if(!stream){ toast("Start Camera first"); return; }
      els.status.textContent = "Scanning...";
      if('BarcodeDetector' in window){
        try{
          const track = stream.getVideoTracks()[0];
          const imageCapture = new ImageCapture(track);
          const bmp = await imageCapture.grabFrame();
          const cvs = document.createElement('canvas');
          cvs.width = bmp.width; cvs.height = bmp.height;
          const ctx = cvs.getContext('2d');
          ctx.drawImage(bmp, 0, 0);
          const detector = new BarcodeDetector({ formats: ['qr_code','code_128','code_39','ean_13','ean_8','codabar','itf','upc_a','upc_e'] });
          const codes = await detector.detect(cvs);
          if(codes && codes.length){
            const b = codes[0];
            setScan(b.rawValue, b.format);
            els.status.textContent = "Scanned. You can SCAN again if needed.";
            return;
          } else {
            els.status.textContent = "No code found, try again.";
            return;
          }
        }catch(e){
          console.warn(e);
          els.status.textContent = "Scan failed. Trying fallback...";
        }
      }
      // ZXing fallback one-shot
      try{
        const reader = new ZXingBrowser.BrowserMultiFormatReader();
        const result = await reader.decodeOnceFromVideoDevice(undefined, 'video');
        if(result){ setScan(result.getText(), result.getBarcodeFormat()); els.status.textContent = "Scanned."; }
        else { els.status.textContent = "No code found."; }
      }catch(e){
        console.warn(e);
        els.status.textContent = "Scan error. Reposition and try again.";
      }
    }

    function chooseAction(act){
      usedAction = act;
      updateInstruction();
      toast(act);
    }

    async function goToForm(){
      if(!lastCode){ toast("Scan a barcode first"); return; }
      try{
        await navigator.clipboard.writeText(els.instruction.value);
        localStorage.setItem('lastInstruction', els.instruction.value);
      }catch(e){}
      try{
        const u = new URL(FORMS_URL);
        u.searchParams.set(BATCH_PARAM, lastCode);
        window.location.href = u.toString();
      }catch(e){
        window.location.href = FORMS_URL;
      }
    }

    // Wire up
    els.btnStart.addEventListener('click', startCamera);
    els.btnScan.addEventListener('click', scanOnce);
    els.btnStartUse.addEventListener('click', ()=>chooseAction('START USE'));
    els.btnFinishUsed.addEventListener('click', ()=>chooseAction('FINISH USED'));
    els.btnForm.addEventListener('click', goToForm);
    els.btnFlash.addEventListener('click', async ()=>{
      if(!stream){ toast("Start Camera first"); return; }
      await setTorch(!torchOn);
    });
    els.dtInput.addEventListener('change', updateInstruction);
    els.dtInput.addEventListener('input', updateInstruction);

    // Restore last instruction if any
    try{
      const prev = localStorage.getItem('lastInstruction');
      if(prev){ els.instruction.value = prev; }
    }catch{}

    // optional: prevent screen sleep on some browsers
    if (navigator.wakeLock && navigator.wakeLock.request) {
      let lock = null;
      const lockIt = async () => { try { lock = await navigator.wakeLock.request('screen'); } catch(e){} };
      lockIt();
      document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') lockIt(); });
    }
  </script>
</body>
</html>
