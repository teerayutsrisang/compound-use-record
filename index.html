<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Batch Scanner (to MS Form)</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;margin:0;padding:10px;background:#f4f4f9;color:#333}
    #container{max-width:600px;margin:0 auto;background:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1);padding:20px}
    h1{text-align:center;margin-top:0}
    #qr-reader{width:100%;border:1px solid #ccc;border-radius:8px;margin-top:15px;display:none}
    #scan-btn{width:100%;font-size:1.5em;padding:20px;background:#007bff;color:#fff;border:none;border-radius:8px;cursor:pointer}
    .label{font-size:12px;color:#6c757d;margin:15px 0 5px 0}
    .input-row{display:flex;gap:10px}
    .resultInput{padding:12px;border-radius:12px;border:1px solid #ccc;background:#f4f4f9;color:#333;font-weight:bold;font-size:24px;text-align:center;box-sizing:border-box}
    #batch-id{flex-grow:1;width:70%;font-size:24px}
    #manual-code{width:80px;flex-shrink:0;font-size:24px}
    #manual-date{width:60%;font-size:1.2em}
    #manual-time{width:40%;font-size:1.2em}
    .button-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:15px}
    .action-btn,#btn-form{font-size:1.2em;padding:20px;border:none;border-radius:8px;cursor:pointer;color:#fff}
    #btn-start{background:#28a745}
    #btn-finish{background:#dc3545}
    #instruction{width:100%;box-sizing:border-box;padding:10px;border-radius:8px;border:1px solid #ccc;font-family:monospace;background:#f4f4f9;font-size:1.5em;font-weight:bold;min-height:120px}
    #btn-form{width:100%;margin-top:15px;background:#6c757d}
    #status{margin-top:15px;font-weight:bold;text-align:center;font-size:1em;color:#007bff;min-height:1.5em}
  </style>
</head>
<body>
  <div id="container">
    <h1>Batch Logger</h1>

    <button id="scan-btn">1. Scan Batch</button>
    <div id="qr-reader"></div>

    <div class="label">Batch ID & Manual Code:</div>
    <div class="input-row">
      <input id="batch-id" class="resultInput" placeholder="Scan Batch ID..." />
      <input id="manual-code" class="resultInput" placeholder="000" maxlength="3" />
    </div>

    <div class="button-grid">
      <button id="btn-start" class="action-btn">2. START USE</button>
      <button id="btn-finish" class="action-btn">2. FINISH USED</button>
    </div>

    <div class="label">Adjust Date & Time (if needed):</div>
    <div class="input-row">
      <input type="date" id="manual-date" class="resultInput" />
      <input type="time" id="manual-time" class="resultInput" />
    </div>

    <div class="label">Data to Record:</div>
    <textarea id="instruction" readonly>Scan a code and select an action...</textarea>

    <button id="btn-form" disabled>3. Go to Form (prefilled)</button>
    <div id="status"></div>
  </div>

  <script>
    // Your base Forms URL (not used once prefill is set, kept as fallback)
    const FORMS_URL =
      "https://forms.office.com/Pages/ResponsePage.aspx?id=EhsYHpKcZU2onbGGEHzETbeUVW5sz-BJrp_dYv8vQNtUNDVIWkJJTFBYUzVXTDRQVU1VQ0tTQ1JBMS4u";

    // PREFILL TEMPLATE using your parameter name:
    // We replace only the value with our live text.
    const PREFILL_TEMPLATE =
      "https://forms.office.com/Pages/ResponsePage.aspx?id=EhsYHpKcZU2onbGGEHzETbeUVW5sz-BJrp_dYv8vQNtUNDVIWkJJTFBYUzVXTDRQVU1VQ0tTQ1JBMS4u"
      + "&r64dd8a4e83d44a31b54a97344fe84d3a=__TEXT__";

    // ==== UI refs ====
    const scanBtn = document.getElementById("scan-btn");
    const qrReaderDiv = document.getElementById("qr-reader");
    const batchIdInput = document.getElementById("batch-id");
    const manualCodeInput = document.getElementById("manual-code");
    const startBtn = document.getElementById("btn-start");
    const finishBtn = document.getElementById("btn-finish");
    const manualDateInput = document.getElementById("manual-date");
    const manualTimeInput = document.getElementById("manual-time");
    const instructionText = document.getElementById("instruction");
    const formBtn = document.getElementById("btn-form");
    const statusDiv = document.getElementById("status");

    let lastAction = "";
    let html5QrCode = null;

    function getISODate(d){return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0")}
    function getISOTime(d){return String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0")}

    // Start camera + scanner
    scanBtn.addEventListener("click", async () => {
      try{
        if(!html5QrCode){ html5QrCode = new Html5Qrcode("qr-reader"); }
        qrReaderDiv.style.display = "block";
        statusDiv.textContent = "Starting camera...";
        await html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: { width: 250, height: 250 } },
          onScanSuccess,
          () => {} // ignore failures
        );
      }catch(e){
        statusDiv.textContent = "Error: Cannot start camera. Check HTTPS & permission.";
      }
    });

    async function stopScanner(){
      try{ if(html5QrCode){ await html5QrCode.stop(); } }catch(_){}
      qrReaderDiv.style.display = "none";
    }

    function onScanSuccess(decodedText){
      stopScanner();
      batchIdInput.value = decodedText;
      statusDiv.textContent = `Scan Successful: ${decodedText}`;
      updateInstruction();
      manualCodeInput.focus();
    }

    // Action buttons
    startBtn.addEventListener("click", () => {
      lastAction = "START USE";
      const now = new Date();
      manualDateInput.value = getISODate(now);
      manualTimeInput.value = getISOTime(now);
      updateInstruction();
    });

    finishBtn.addEventListener("click", () => {
      lastAction = "FINISH USED";
      const now = new Date();
      manualDateInput.value = getISODate(now);
      manualTimeInput.value = getISOTime(now);
      updateInstruction();
    });

    // Input listeners
    [batchIdInput, manualCodeInput, manualDateInput, manualTimeInput]
      .forEach(el => el.addEventListener("input", updateInstruction));

    function updateInstruction(){
      const batchId = batchIdInput.value.trim();
      const manualCode = manualCodeInput.value.trim();
      const dateValue = manualDateInput.value;   // YYYY-MM-DD
      const timeValue = manualTimeInput.value;   // HH:MM

      if(!batchId){ instructionText.value = "1. Scan a code..."; formBtn.disabled = true; return; }
      if(!manualCode){ instructionText.value = `Scanned: ${batchId}.\n2. Enter 3-digit code.`; formBtn.disabled = true; return; }
      if(!lastAction){ instructionText.value = `Data: ${batchId} ${manualCode}.\n3. Select START or FINISH.`; formBtn.disabled = true; return; }
      if(!dateValue || !timeValue){ instructionText.value = `Data: ${batchId} ${manualCode}.\nAction: ${lastAction}.\n4. Date/Time is loading...`; formBtn.disabled = true; return; }

      const [yyyy, mm, dd] = dateValue.split("-");
      const formattedDateTime = `${dd}/${mm}/${yyyy} ${timeValue}`;
      instructionText.value = `${batchId} ${manualCode}, ${lastAction}, ${formattedDateTime}`;
      formBtn.disabled = false;
    }

    formBtn.addEventListener("click", () => {
      const code = batchIdInput.value.trim();
      const manual = manualCodeInput.value.trim();
      const dateValue = manualDateInput.value;
      const timeValue = manualTimeInput.value;

      if(!code || !manual || !lastAction || !dateValue || !timeValue){
        alert("Please fill Scan, Code, Action and Date/Time.");
        return;
      }

      const [yyyy, mm, dd] = dateValue.split("-");
      const dtDisplay = `${dd}/${mm}/${yyyy} ${timeValue}`;

      // Compose the single answer text for Question 1
      const prefillText = `${code} ${manual}, ${lastAction}, ${dtDisplay}`;

      // Optional: copy to clipboard for backup
      try{ navigator.clipboard.writeText(prefillText); }catch(_){}

      // Open MS Form already filled
      const url = PREFILL_TEMPLATE.replace("__TEXT__", encodeURIComponent(prefillText));
      window.location.href = url;
    });
  </script>
</body>
</html>
